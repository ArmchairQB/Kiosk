<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sophien Post und Shop - Lagerverwaltung</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
        }
        .tabs {
            display: flex;
            background: #34495e;
            overflow-x: auto;
        }
        .tab {
            padding: 15px 20px;
            background: #34495e;
            color: white;
            border: none;
            cursor: pointer;
            white-space: nowrap;
            transition: background 0.3s;
        }
        .tab:hover, .tab.active {
            background: #2c3e50;
        }
        .tab-content {
            display: none;
            padding: 20px;
        }
        .tab-content.active {
            display: block;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 14px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f8f9fa;
            font-weight: bold;
            position: sticky;
            top: 0;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .category-header {
            background-color: #e3f2fd !important;
            font-weight: bold;
            color: #1976d2;
        }
        input[type="number"], input[type="text"], select {
            width: 100%;
            padding: 4px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
        .low-stock {
            background-color: #ffebee !important;
        }
        .out-of-stock {
            background-color: #f3e5f5 !important;
        }
        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background: #2980b9;
        }
        .btn-success {
            background: #27ae60;
        }
        .btn-success:hover {
            background: #229954;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
        }
        .shopping-list {
            background: #fff3cd;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .vat-7 { background-color: #e8f5e8; }
        .vat-19 { background-color: #fff2e8; }
        .seasonal-item { border-left: 4px solid #ff9800; }
        .consignment-item { border-left: 4px solid #9c27b0; }
        .search-box {
            width: 300px;
            padding: 8px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .supplier-selgros { color: #e74c3c; font-weight: bold; }
        .supplier-metro { color: #3498db; font-weight: bold; }
        .supplier-konsignment { color: #9b59b6; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Sophien Post und Shop</h1>
            <p>Lagerverwaltungssystem - Frankfurt am Main</p>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="showTab('inventory')">Hauptlager</button>
            <button class="tab" onclick="showTab('consignment')">Konsignationsware</button>
            <button class="tab" onclick="showTab('stock-update')">Bestandsupdate</button>
            <button class="tab" onclick="showTab('shopping-list')">Einkaufsliste</button>
            <button class="tab" onclick="showTab('seasonal')">Saisonware</button>
            <button class="tab" onclick="showTab('reports')">Berichte</button>
        </div>

        <div id="inventory" class="tab-content active">
            <h2>Hauptlager - Warenbestand</h2>
            <input type="text" id="searchBox" class="search-box" placeholder="Artikel suchen..." onkeyup="filterTable()">
            <button class="btn" onclick="addNewProduct()">Neuer Artikel</button>
            <button class="btn btn-success" onclick="saveInventory()">Änderungen speichern</button>
            
            <div style="overflow-x: auto; max-height: 600px;">
                <table id="inventoryTable">
                    <thead>
                        <tr>
                            <th>Kategorie</th>
                            <th>Artikelname</th>
                            <th>Aktueller Bestand</th>
                            <th>Mindestbestand</th>
                            <th>Maximalbestand</th>
                            <th>EK-Preis (€)</th>
                            <th>VK-Preis (€)</th>
                            <th>MwSt %</th>
                            <th>Lieferant</th>
                            <th>Notizen</th>
                            <th>Aktion</th>
                        </tr>
                    </thead>
                    <tbody id="inventoryBody">
                        </tbody>
                </table>
            </div>
        </div>

        <div id="consignment" class="tab-content">
            <h2>Konsignationsware</h2>
            <button class="btn" onclick="addNewConsignmentProduct()">Neuer Konsignationsartikel</button>
            <button class="btn btn-success" onclick="saveInventory()">Änderungen speichern</button>

            <div style="overflow-x: auto; max-height: 600px;">
                <table id="consignmentTable">
                    <thead>
                        <tr>
                            <th>Kategorie</th>
                            <th>Artikelname</th>
                            <th>Aktueller Bestand</th>
                            <th>Mindestbestand</th>
                            <th>Maximalbestand</th>
                            <th>VK-Preis (€)</th>
                            <th>Kommission (%)</th>
                            <th>Ihre Einnahme (€)</th>
                            <th>MwSt %</th>
                            <th>Lieferant (Konsignant)</th>
                            <th>Notizen</th>
                            <th>Aktion</th>
                        </tr>
                    </thead>
                    <tbody id="consignmentBody">
                        </tbody>
                </table>
            </div>
        </div>

        <div id="stock-update" class="tab-content">
            <h2>Tägliches Bestandsupdate</h2>
            <div class="stats">
                <div class="stat-card">
                    <h3 id="lowStockCount">0</h3>
                    <p>Artikel unter Mindestbestand</p>
                </div>
                <div class="stat-card">
                    <h3 id="outOfStockCount">0</h3>
                    <p>Ausverkauft</p>
                </div>
                <div class="stat-card">
                    <h3 id="totalValue">€0</h3>
                    <p>Gesamtlagerwert</p>
                </div>
                <div class="stat-card">
                    <h3 id="totalConsignmentValue">€0</h3>
                    <p>Wert Konsignationsware (VK)</p>
                </div>
            </div>
            
            <h3>Schnelle Bestandsanpassungen</h3>
            <table>
                <thead>
                    <tr>
                        <th>Artikel</th>
                        <th>Aktueller Bestand</th>
                        <th>Anpassung</th>
                        <th>Grund</th>
                        <th>Aktualisieren</th>
                    </tr>
                </thead>
                <tbody id="stockUpdateBody">
                    </tbody>
            </table>
        </div>

        <div id="shopping-list" class="tab-content">
            <h2>Einkaufsliste Generator</h2>
            <button class="btn" onclick="generateShoppingList()">Einkaufsliste erstellen</button>
            <button class="btn" onclick="printShoppingList()">Liste drucken</button>
            
            <div id="shoppingListContent">
                </div>
        </div>

        <div id="seasonal" class="tab-content">
            <h2>Saisonware & Sonderartikel</h2>
            <button class="btn" onclick="addSeasonalItem()">Saisonartikel hinzufügen</button>
            
            <table>
                <thead>
                    <tr>
                        <th>Artikel</th>
                        <th>Saison/Zeitraum</th>
                        <th>Bestandslevel</th>
                        <th>Status</th>
                        <th>Notizen</th>
                    </tr>
                </thead>
                <tbody id="seasonalBody">
                    </tbody>
            </table>
        </div>

        <div id="reports" class="tab-content">
            <h2>Lagerberichte</h2>
            <div class="stats">
                <div class="stat-card">
                    <h3 id="reportTotalItems">0</h3>
                    <p>Gesamtartikel</p>
                </div>
                <div class="stat-card">
                    <h3 id="reportCategories">0</h3>
                    <p>Produktkategorien</p>
                </div>
                <div class="stat-card">
                    <h3 id="reportConsignment">0</h3>
                    <p>Konsignationsartikel</p>
                </div>
                <div class="stat-card">
                    <h3 id="reportConsignmentValue">€0</h3>
                    <p>Geschätzte Konsignationseinnahmen</p>
                </div>
            </div>
            
            <h3>Kategorien-Übersicht</h3>
            <div id="categoryReport"></div>
        </div>
    </div>

    <script>
        // Beispieldaten für deutschen Convenience Store
        let inventory = [];
        let consignmentInventory = []; // Separate array for consignment items

        let categories = [
            'Papierprodukte', 'Büroartikel', 'Bier', 'Alcopops', 'Cider',
            'Spirituosen: große Flaschen', 'Spirituosen: mittlere Flaschen', 'Spirituosen: kleine Flaschen',
            'Wein/Sekt', 'Erfrischungsgetränke: Dosen klein', 'Erfrischungsgetränke: Dosen groß',
            'Erfrischungsgetränke: Flaschen klein', 'Erfrischungsgetränke: Flaschen mittel', 
            'Erfrischungsgetränke: Flaschen groß', 'Erfrischungsgetränke: Tetrapack',
            'Energy Drinks', 'Durstlöscher', 'Chips', 'Nüsse',
            'Kaffee: Bohnen', 'Kaffee: Instant', 'Süßwaren fein', 'Kaugummi/Bonbons',
            'Hustenbonbons/Harte Bonbons', 'Süßigkeiten', 'Mineralwasser: still groß',
            'Mineralwasser: still mittel', 'Mineralwasser: still klein',
            'Mineralwasser: gas groß', 'Mineralwasser: gas mittel', 'Mineralwasser: gas klein',
            'Tabakwaren: Schnupftabak', 'Tabakwaren: Zigaretten 9€', 'Tabakwaren: Zigaretten 10€',
            'Tabakwaren: Zigaretten 12€', 'Tabakwaren: Zigaretten 15€', 'Tabakwaren: Zigaretten 20€',
            'Tabakwaren: Zigaretten 30€', 'Tabakwaren: Drehtabak', 'Tabakwaren: E-Zigaretten',
            'Tabakwaren: Aktivkohlefilter', 'Tabakwaren: Filter', 'Tabakwaren: Longpapers',
            'Tabakwaren: Papers kurz', 'Tabakwaren: Stopfhülsen', 'Tabakwaren: Stopfgerät',
            'Eis', 'Kekse', 'Gummibärchen/Haribo', 'Säfte: Tetrapack', 'Säfte: Flaschen',
            'Drogerie: Körperpflege', 'Drogerie: Damenhygiene', 'Drogerie: Kondome',
            'Lebensmittel: Nudeln', 'Lebensmittel: Pesto', 'Lebensmittel: Konserven', 
            'Lebensmittel: Nutella', 'Lebensmittel: Olivenöl', 'Lebensmittel: Speiseöl',
            'Lebensmittel: Haferflocken', 'Lebensmittel: Mehl', 'Lebensmittel: Zucker',
            'Lebensmittel: H-Milch', 'Lebensmittel: H-Sahne', 'Lebensmittel: Müsli',
            'Lebensmittel: Alufolie', 'Lebensmittel: Fertiggerichte', 'Lebensmittel: Essiggurken',
            'Lebensmittel: Brot abgepackt', 'Lebensmittel: Babynahrung', 'Lebensmittel: Salz',
            'Lebensmittel: Pfeffer', 'Lebensmittel: Würzmittel', 'Lebensmittel: Bockwurst'
        ];

        let suppliers = ['Selgros', 'Metro', 'Großmarkt Frankfurt', 'Sonstige']; // Removed 'Konsignation' as a general supplier

        // With sample data initialize
        function initializeInventory() {
            inventory = [
                {
                    category: 'Tabakwaren: Zigaretten 10€',
                    name: 'Marlboro Red',
                    currentStock: 2,
                    minLevel: 5,
                    maxLevel: 20,
                    purchasePrice: 8.20,
                    sellingPrice: 10.00,
                    vat: 19,
                    supplier: 'Selgros',
                    notes: 'Standardware',
                    isConsignment: false
                },
                {
                    category: 'Bier',
                    name: 'Becks 0,5l',
                    currentStock: 24,
                    minLevel: 10,
                    maxLevel: 50,
                    purchasePrice: 0.65,
                    sellingPrice: 1.20,
                    vat: 19,
                    supplier: 'Selgros',
                    notes: 'Kiste à 24 Flaschen',
                    isConsignment: false
                },
                {
                    category: 'Erfrischungsgetränke: Flaschen klein',
                    name: 'Coca Cola 0,33l',
                    currentStock: 18,
                    minLevel: 12,
                    maxLevel: 36,
                    purchasePrice: 0.55,
                    sellingPrice: 1.00,
                    vat: 19,
                    supplier: 'Metro',
                    notes: 'Glasflasche',
                    isConsignment: false
                },
                {
                    category: 'Lebensmittel: Nudeln',
                    name: 'Barilla Spaghetti 500g',
                    currentStock: 8,
                    minLevel: 5,
                    maxLevel: 20,
                    purchasePrice: 1.20,
                    sellingPrice: 2.10,
                    vat: 7,
                    supplier: 'Selgros',
                    notes: 'Standardformat',
                    isConsignment: false
                }
            ];

            consignmentInventory = [
                {
                    category: 'Kaffee: Bohnen',
                    name: 'Premium Arabica Bohnen 1kg',
                    currentStock: 5,
                    minLevel: 3,
                    maxLevel: 15,
                    sellingPrice: 18.90,
                    commission: 20, // 20% commission
                    vat: 7,
                    supplier: 'Konsignation: Lokaler Röster',
                    notes: 'Aktuelle Konsignationsvereinbarung',
                    isConsignment: true
                },
                {
                    category: 'Spirituosen: kleine Flaschen',
                    name: 'Handgemachter Gin 0,1l',
                    currentStock: 10,
                    minLevel: 5,
                    maxLevel: 25,
                    sellingPrice: 8.50,
                    commission: 30,
                    vat: 19,
                    supplier: 'Konsignation: Kleine Brennerei',
                    notes: 'Sonderposten',
                    isConsignment: true
                }
            ];
            
            renderInventoryTable();
            renderConsignmentTable();
            updateStats();
        }

        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            if (tabName === 'reports') {
                generateReports();
            } else if (tabName === 'stock-update') {
                renderStockUpdateTable();
            }
        }

        function renderInventoryTable() {
            const tbody = document.getElementById('inventoryBody');
            tbody.innerHTML = '';
            
            inventory.forEach((item, index) => {
                const row = document.createElement('tr');
                
                // Color coding for different states
                if (item.currentStock === 0) {
                    row.classList.add('out-of-stock');
                } else if (item.currentStock <= item.minLevel) {
                    row.classList.add('low-stock');
                }
                
                if (item.vat === 7) {
                    row.classList.add('vat-7');
                } else if (item.vat === 19) {
                    row.classList.add('vat-19');
                }
                
                row.innerHTML = `
                    <td>
                        <select onchange="updateInventoryItem(${index}, 'category', this.value, false)">
                            ${categories.map(cat => 
                                `<option value="${cat}" ${cat === item.category ? 'selected' : ''}>${cat}</option>`
                            ).join('')}
                        </select>
                    </td>
                    <td><input type="text" value="${item.name}" onchange="updateInventoryItem(${index}, 'name', this.value, false)"></td>
                    <td><input type="number" value="${item.currentStock}" onchange="updateInventoryItem(${index}, 'currentStock', this.value, false)"></td>
                    <td><input type="number" value="${item.minLevel}" onchange="updateInventoryItem(${index}, 'minLevel', this.value, false)"></td>
                    <td><input type="number" value="${item.maxLevel}" onchange="updateInventoryItem(${index}, 'maxLevel', this.value, false)"></td>
                    <td><input type="number" step="0.01" value="${item.purchasePrice}" onchange="updateInventoryItem(${index}, 'purchasePrice', this.value, false)"></td>
                    <td><input type="number" step="0.01" value="${item.sellingPrice}" onchange="updateInventoryItem(${index}, 'sellingPrice', this.value, false)"></td>
                    <td>
                        <select onchange="updateInventoryItem(${index}, 'vat', this.value, false)">
                            <option value="7" ${item.vat === 7 ? 'selected' : ''}>7%</option>
                            <option value="19" ${item.vat === 19 ? 'selected' : ''}>19%</option>
                        </select>
                    </td>
                    <td>
                        <select onchange="updateInventoryItem(${index}, 'supplier', this.value, false)">
                            ${suppliers.map(sup => 
                                `<option value="${sup}" ${sup === item.supplier ? 'selected' : ''}>${sup}</option>`
                            ).join('')}
                        </select>
                    </td>
                    <td><input type="text" value="${item.notes || ''}" onchange="updateInventoryItem(${index}, 'notes', this.value, false)"></td>
                    <td><button class="btn" onclick="deleteInventoryItem(${index}, false)" style="background: #e74c3c;">Löschen</button></td>
                `;
                
                tbody.appendChild(row);
            });
        }

        function renderConsignmentTable() {
            const tbody = document.getElementById('consignmentBody');
            tbody.innerHTML = '';
            
            consignmentInventory.forEach((item, index) => {
                const row = document.createElement('tr');
                row.classList.add('consignment-item'); // Add class for consignment items
                
                // Color coding for different states
                if (item.currentStock === 0) {
                    row.classList.add('out-of-stock');
                } else if (item.currentStock <= item.minLevel) {
                    row.classList.add('low-stock');
                }
                
                if (item.vat === 7) {
                    row.classList.add('vat-7');
                } else if (item.vat === 19) {
                    row.classList.add('vat-19');
                }

                const yourEarnings = ((item.sellingPrice * item.commission) / 100).toFixed(2);
                
                row.innerHTML = `
                    <td>
                        <select onchange="updateInventoryItem(${index}, 'category', this.value, true)">
                            ${categories.map(cat => 
                                `<option value="${cat}" ${cat === item.category ? 'selected' : ''}>${cat}</option>`
                            ).join('')}
                        </select>
                    </td>
                    <td><input type="text" value="${item.name}" onchange="updateInventoryItem(${index}, 'name', this.value, true)"></td>
                    <td><input type="number" value="${item.currentStock}" onchange="updateInventoryItem(${index}, 'currentStock', this.value, true)"></td>
                    <td><input type="number" value="${item.minLevel}" onchange="updateInventoryItem(${index}, 'minLevel', this.value, true)"></td>
                    <td><input type="number" value="${item.maxLevel}" onchange="updateInventoryItem(${index}, 'maxLevel', this.value, true)"></td>
                    <td><input type="number" step="0.01" value="${item.sellingPrice}" onchange="updateInventoryItem(${index}, 'sellingPrice', this.value, true)"></td>
                    <td><input type="number" step="1" min="5" max="30" value="${item.commission}" onchange="updateInventoryItem(${index}, 'commission', this.value, true)"></td>
                    <td>€${yourEarnings}</td>
                    <td>
                        <select onchange="updateInventoryItem(${index}, 'vat', this.value, true)">
                            <option value="7" ${item.vat === 7 ? 'selected' : ''}>7%</option>
                            <option value="19" ${item.vat === 19 ? 'selected' : ''}>19%</option>
                        </select>
                    </td>
                    <td><input type="text" value="${item.supplier || ''}" onchange="updateInventoryItem(${index}, 'supplier', this.value, true)"></td>
                    <td><input type="text" value="${item.notes || ''}" onchange="updateInventoryItem(${index}, 'notes', this.value, true)"></td>
                    <td><button class="btn" onclick="deleteInventoryItem(${index}, true)" style="background: #e74c3c;">Löschen</button></td>
                `;
                
                tbody.appendChild(row);
            });
        }

        function updateInventoryItem(index, field, value, isConsignment) {
            let targetArray = isConsignment ? consignmentInventory : inventory;

            if (field === 'currentStock' || field === 'minLevel' || field === 'maxLevel' || field === 'commission') {
                targetArray[index][field] = parseInt(value) || 0;
            } else if (field === 'purchasePrice' || field === 'sellingPrice') {
                targetArray[index][field] = parseFloat(value) || 0;
            } else if (field === 'vat') {
                targetArray[index][field] = parseInt(value);
            } else {
                targetArray[index][field] = value;
            }
            
            if (isConsignment) {
                renderConsignmentTable();
            } else {
                renderInventoryTable();
            }
            updateStats();
        }

        function deleteInventoryItem(index, isConsignment) {
            if (confirm('Artikel wirklich löschen?')) {
                if (isConsignment) {
                    consignmentInventory.splice(index, 1);
                    renderConsignmentTable();
                } else {
                    inventory.splice(index, 1);
                    renderInventoryTable();
                }
                updateStats();
            }
        }

        function addNewProduct() {
            const newProduct = {
                category: categories[0],
                name: 'Neuer Artikel',
                currentStock: 0,
                minLevel: 1,
                maxLevel: 10,
                purchasePrice: 0.00,
                sellingPrice: 0.00,
                vat: 19,
                supplier: 'Selgros',
                notes: '',
                isConsignment: false
            };
            
            inventory.push(newProduct);
            renderInventoryTable();
            updateStats();
        }

        function addNewConsignmentProduct() {
            const newConsignmentProduct = {
                category: categories[0],
                name: 'Neuer Konsignationsartikel',
                currentStock: 0,
                minLevel: 1,
                maxLevel: 10,
                sellingPrice: 0.00,
                commission: 20, // Default commission
                vat: 19,
                supplier: 'Konsignation: Neuer Lieferant',
                notes: '',
                isConsignment: true
            };
            
            consignmentInventory.push(newConsignmentProduct);
            renderConsignmentTable();
            updateStats();
        }

        function updateStats() {
            let lowStockCount = 0;
            let outOfStockCount = 0;
            let totalValue = 0;
            let totalConsignmentValue = 0;
            let estimatedConsignmentEarnings = 0;
            
            inventory.forEach(item => {
                if (item.currentStock === 0) {
                    outOfStockCount++;
                } else if (item.currentStock <= item.minLevel) {
                    lowStockCount++;
                }
                
                totalValue += item.currentStock * item.purchasePrice;
            });

            consignmentInventory.forEach(item => {
                if (item.currentStock === 0) {
                    outOfStockCount++;
                } else if (item.currentStock <= item.minLevel) {
                    lowStockCount++;
                }
                totalConsignmentValue += item.currentStock * item.sellingPrice;
                estimatedConsignmentEarnings += item.currentStock * (item.sellingPrice * (item.commission / 100));
            });
            
            document.getElementById('lowStockCount').textContent = lowStockCount;
            document.getElementById('outOfStockCount').textContent = outOfStockCount;
            document.getElementById('totalValue').textContent = `€${totalValue.toFixed(2)}`;
            document.getElementById('totalConsignmentValue').textContent = `€${totalConsignmentValue.toFixed(2)}`;
        }

        function renderStockUpdateTable() {
            const tbody = document.getElementById('stockUpdateBody');
            tbody.innerHTML = '';
            
            // Show items from both inventories that are below minLevel or out of stock
            const criticalItems = [
                ...inventory.map((item, idx) => ({ ...item, originalIndex: idx, isConsignment: false })),
                ...consignmentInventory.map((item, idx) => ({ ...item, originalIndex: idx, isConsignment: true }))
            ].filter(item => 
                item.currentStock <= item.minLevel
            );
            
            criticalItems.forEach((item) => {
                const row = document.createElement('tr');
                
                if (item.currentStock === 0) {
                    row.classList.add('out-of-stock');
                } else {
                    row.classList.add('low-stock');
                }
                
                row.innerHTML = `
                    <td>${item.name} ${item.isConsignment ? '(Konsignation)' : ''}</td>
                    <td>${item.currentStock}</td>
                    <td><input type="number" id="adjustment_${item.originalIndex}_${item.isConsignment}" placeholder="±Anzahl"></td>
                    <td>
                        <select id="reason_${item.originalIndex}_${item.isConsignment}">
                            <option value="Verkauf">Verkauf</option>
                            <option value="Einkauf">Einkauf</option>
                            <option value="Verlust">Verlust/Beschädigung</option>
                            <option value="Korrektur">Inventurkorrektur</option>
                        </select>
                    </td>
                    <td><button class="btn" onclick="applyStockAdjustment(${item.originalIndex}, ${item.isConsignment})">Anwenden</button></td>
                `;
                
                tbody.appendChild(row);
            });
        }

        function applyStockAdjustment(index, isConsignment) {
            const adjustmentInput = document.getElementById(`adjustment_${index}_${isConsignment}`);
            const reasonSelect = document.getElementById(`reason_${index}_${isConsignment}`);
            
            const adjustment = parseInt(adjustmentInput.value) || 0;
            const reason = reasonSelect.value;
            
            let targetArray = isConsignment ? consignmentInventory : inventory;

            if (adjustment !== 0) {
                targetArray[index].currentStock += adjustment;
                if (targetArray[index].currentStock < 0) {
                    targetArray[index].currentStock = 0;
                }
                
                // Log the change (can be extended later)
                console.log(`Bestandsänderung: ${targetArray[index].name}, ${adjustment}, Grund: ${reason}`);
                
                adjustmentInput.value = '';
                renderStockUpdateTable();
                updateStats();
                
                alert(`Bestand aktualisiert: ${targetArray[index].name}`);
            }
        }

        function generateShoppingList() {
            const shoppingList = inventory.filter(item => 
                item.currentStock <= item.minLevel
            );
            // Consignment items are not "purchased", so they are excluded from the shopping list

            // Group by supplier
            const listBySupplier = {};
            shoppingList.forEach(item => {
                if (!listBySupplier[item.supplier]) {
                    listBySupplier[item.supplier] = [];
                }
                
                const neededQuantity = item.maxLevel - item.currentStock;
                listBySupplier[item.supplier].push({
                    ...item,
                    neededQuantity
                });
            });
            
            const content = document.getElementById('shoppingListContent');
            content.innerHTML = '';
            
            if (Object.keys(listBySupplier).length === 0) {
                content.innerHTML = '<div class="shopping-list"><h3>Keine Artikel zu bestellen!</h3><p>Alle Artikel sind über dem Mindestbestand.</p></div>';
                return;
            }
            
            Object.entries(listBySupplier).forEach(([supplier, items]) => {
                const supplierDiv = document.createElement('div');
                supplierDiv.className = 'shopping-list';
                
                let totalCost = 0;
                let itemList = '<ul>';
                
                items.forEach(item => {
                    const itemCost = item.neededQuantity * item.purchasePrice;
                    totalCost += itemCost;
                    
                    itemList += `
                        <li>
                            <strong>${item.name}</strong><br>
                            Aktuell: ${item.currentStock} | Benötigt: ${item.neededQuantity} Stück<br>
                            EK: €${item.purchasePrice.toFixed(2)} | Gesamt: €${itemCost.toFixed(2)}<br>
                            <em>${item.category}</em>
                        </li>
                    `;
                });
                
                itemList += '</ul>';
                
                supplierDiv.innerHTML = `
                    <h3>🏪 ${supplier}</h3>
                    ${itemList}
                    <p><strong>Gesamtkosten ${supplier}: €${totalCost.toFixed(2)}</strong></p>
                `;
                
                content.appendChild(supplierDiv);
            });
        }

        function printShoppingList() {
            const content = document.getElementById('shoppingListContent');
            if (content.innerHTML.trim() === '') {
                generateShoppingList();
            }
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>Einkaufsliste - Sophien Post und Shop</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 20px; }
                            .header { text-align: center; margin-bottom: 20px; }
                            .shopping-list { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
                            ul { list-style-type: disc; margin-left: 20px; }
                            li { margin: 10px 0; }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <h1>Sophien Post und Shop</h1>
                            <h2>Einkaufsliste</h2>
                            <p>Datum: ${new Date().toLocaleDateString('de-DE')}</p>
                        </div>
                        ${content.innerHTML}
                    </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.print();
        }

        function generateReports() {
            document.getElementById('reportTotalItems').textContent = inventory.length + consignmentInventory.length;
            
            const allCategories = new Set([...inventory.map(item => item.category), ...consignmentInventory.map(item => item.category)]);
            document.getElementById('reportCategories').textContent = allCategories.size;
            
            document.getElementById('reportConsignment').textContent = consignmentInventory.length;
            
            let totalConsignmentEarnings = 0;
            consignmentInventory.forEach(item => {
                totalConsignmentEarnings += item.currentStock * (item.sellingPrice * (item.commission / 100));
            });
            document.getElementById('reportConsignmentValue').textContent = `€${totalConsignmentEarnings.toFixed(2)}`;

            // Category Report
            const categoryStats = {};
            
            inventory.forEach(item => {
                if (!categoryStats[item.category]) {
                    categoryStats[item.category] = { count: 0, value: 0, lowStock: 0, consignmentCount: 0, consignmentValue: 0, consignmentEarnings: 0 };
                }
                categoryStats[item.category].count++;
                categoryStats[item.category].value += item.currentStock * item.purchasePrice;
                if (item.currentStock <= item.minLevel) {
                    categoryStats[item.category].lowStock++;
                }
            });

            consignmentInventory.forEach(item => {
                if (!categoryStats[item.category]) {
                    categoryStats[item.category] = { count: 0, value: 0, lowStock: 0, consignmentCount: 0, consignmentValue: 0, consignmentEarnings: 0 };
                }
                categoryStats[item.category].count++; // Count consignment items in overall item count
                categoryStats[item.category].consignmentCount++;
                categoryStats[item.category].consignmentValue += item.currentStock * item.sellingPrice;
                categoryStats[item.category].consignmentEarnings += item.currentStock * (item.sellingPrice * (item.commission / 100));
                if (item.currentStock <= item.minLevel) {
                    categoryStats[item.category].lowStock++;
                }
            });
            
            const categoryReport = document.getElementById('categoryReport');
            categoryReport.innerHTML = '';
            
            Object.entries(categoryStats).forEach(([category, stats]) => {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'stat-card';
                categoryDiv.innerHTML = `
                    <h4>${category}</h4>
                    <p>Artikel: ${stats.count}</p>
                    <p>Lagerwert (Ihre Kosten): €${stats.value.toFixed(2)}</p>
                    <p>Konsignationsware (VK Wert): €${stats.consignmentValue.toFixed(2)}</p>
                    <p>Konsignationseinnahmen: €${stats.consignmentEarnings.toFixed(2)}</p>
                    <p>Niedrige Bestände: ${stats.lowStock}</p>
                `;
                categoryReport.appendChild(categoryDiv);
            });
        }

        function filterTable() {
            const searchTerm = document.getElementById('searchBox').value.toLowerCase().trim();
            const rows = document.querySelectorAll('#inventoryBody tr'); // Only filter main inventory table

            rows.forEach(row => {
                const nameInput = row.querySelector('td:nth-child(2) input');
                const categorySelect = row.querySelector('td:nth-child(1) select');
                
                if (nameInput && categorySelect) {
                    const productName = nameInput.value.toLowerCase();
                    const category = categorySelect.value.toLowerCase();
                    
                    const matchesSearch = productName.includes(searchTerm) || 
                                        category.includes(searchTerm);
                    
                    row.style.display = matchesSearch ? '' : 'none';
                }
            });
        }

        function addSeasonalItem() {
            const seasonalBody = document.getElementById('seasonalBody');
            const row = document.createElement('tr');
            row.className = 'seasonal-item';
            
            row.innerHTML = `
                <td><input type="text" placeholder="Saisonartikel Name"></td>
                <td>
                    <select>
                        <option>Weihnachten</option>
                        <option>Ostern</option>
                        <option>Sommer</option>
                        <option>Halloween</option>
                        <option>Silvester</option>
                        <option>Karneval</option>
                        <option>Muttertag</option>
                        <option>Oktoberfest</option>
                    </select>
                </td>
                <td><input type="number" placeholder="0"></td>
                <td>
                    <select>
                        <option>Aktiv</option>
                        <option>Auslaufend</option>
                        <option>Beendet</option>
                    </select>
                </td>
                <td><input type="text" placeholder="Notizen..."></td>
            `;
            
            seasonalBody.appendChild(row);
        }

        function saveInventory() {
            // In a real application, saving would occur here
            // For this demo, we use localStorage
            try {
                const inventoryData = {
                    inventory: inventory,
                    consignmentInventory: consignmentInventory,
                    timestamp: new Date().toISOString(),
                    storeName: 'Sophien Post und Shop'
                };
                
                // Simulate saving process
                console.log('Inventar gespeichert:', inventoryData);
                alert('Inventar erfolgreich gespeichert!\n\nZeitpunkt: ' + new Date().toLocaleString('de-DE'));
                
                // Here you could also implement CSV/Excel export
            } catch (error) {
                alert('Fehler beim Speichern: ' + error.message);
            }
        }

        // CSV Export Function
        function exportToCSV() {
            const headers = ['Kategorie', 'Artikelname', 'Aktueller Bestand', 'Mindestbestand', 'Maximalbestand', 
                           'EK-Preis', 'VK-Preis', 'MwSt %', 'Lieferant', 'Notizen', 'Typ'];
            
            let csvContent = headers.join(';') + '\n';
            
            inventory.forEach(item => {
                const row = [
                    item.category,
                    item.name,
                    item.currentStock,
                    item.minLevel,
                    item.maxLevel,
                    item.purchasePrice.toFixed(2),
                    item.sellingPrice.toFixed(2),
                    item.vat,
                    item.supplier,
                    item.notes || '',
                    'Hauptlager'
                ];
                csvContent += row.join(';') + '\n';
            });

            consignmentInventory.forEach(item => {
                const row = [
                    item.category,
                    item.name,
                    item.currentStock,
                    item.minLevel,
                    item.maxLevel,
                    'N/A', // No purchase price for consignment
                    item.sellingPrice.toFixed(2),
                    item.vat,
                    item.supplier,
                    item.notes || '',
                    `Konsignation (${item.commission}%)`
                ];
                csvContent += row.join(';') + '\n';
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `Sophien_Post_Inventar_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Automatic notifications for critical stocks
        function checkCriticalStock() {
            const criticalItems = [
                ...inventory.filter(item => item.currentStock === 0 || item.currentStock <= item.minLevel),
                ...consignmentInventory.filter(item => item.currentStock === 0 || item.currentStock <= item.minLevel)
            ];
            
            if (criticalItems.length > 0) {
                const message = `⚠️ ACHTUNG: ${criticalItems.length} Artikel benötigen Aufmerksamkeit!\n\n` +
                    criticalItems.map(item => 
                        `• ${item.name}: ${item.currentStock} (Min: ${item.minLevel}) ${item.isConsignment ? '(Konsignation)' : ''}`
                    ).join('\n');
                
                // In a real app, you could send push notifications here
                console.warn('Kritische Bestände:', criticalItems);
            }
        }

        // Gross Margin Calculation (only for regular inventory)
        function calculateMargins() {
            inventory.forEach(item => {
                if (item.purchasePrice > 0 && item.sellingPrice > 0) {
                    const grossMargin = ((item.sellingPrice - item.purchasePrice) / item.sellingPrice * 100).toFixed(1);
                    const markup = ((item.sellingPrice - item.purchasePrice) / item.purchasePrice * 100).toFixed(1);
                    
                    item.grossMargin = grossMargin;
                    item.markup = markup;
                }
            });
        }

        // Supplier Performance Tracking
        function getSupplierStats() {
            const supplierStats = {};
            
            suppliers.forEach(supplier => {
                const supplierItems = inventory.filter(item => item.supplier === supplier);
                const totalValue = supplierItems.reduce((sum, item) => 
                    sum + (item.currentStock * item.purchasePrice), 0);
                const criticalCount = supplierItems.filter(item => 
                    item.currentStock <= item.minLevel).length;
                
                supplierStats[supplier] = {
                    itemCount: supplierItems.length,
                    totalValue: totalValue,
                    criticalItems: criticalCount
                };
            });
            
            return supplierStats;
        }

        // Quick-Add common articles
        const commonProducts = {
            'Marlboro Red': { category: 'Tabakwaren: Zigaretten 10€', purchasePrice: 8.20, sellingPrice: 10.00, vat: 19, isConsignment: false },
            'Coca Cola 0,33l': { category: 'Erfrischungsgetränke: Flaschen klein', purchasePrice: 0.55, sellingPrice: 1.00, vat: 19, isConsignment: false },
            'Red Bull 0,25l': { category: 'Energy Drinks', purchasePrice: 1.20, sellingPrice: 2.50, vat: 19, isConsignment: false },
            'Haribo Goldbären': { category: 'Gummibärchen/Haribo', purchasePrice: 0.89, sellingPrice: 1.59, vat: 7, isConsignment: false },
            'Pringles Original': { category: 'Chips', purchasePrice: 1.80, sellingPrice: 2.99, vat: 19, isConsignment: false },
            'Premium Arabica Bohnen 1kg': { category: 'Kaffee: Bohnen', sellingPrice: 18.90, commission: 20, vat: 7, isConsignment: true }
        };

        function quickAddProduct(productName) {
            if (commonProducts[productName]) {
                const template = commonProducts[productName];
                if (template.isConsignment) {
                    const newProduct = {
                        ...template,
                        name: productName,
                        currentStock: 0,
                        minLevel: 5,
                        maxLevel: 20,
                        supplier: 'Konsignation: ' + productName.split(' ')[0], // Example supplier name for consignment
                        notes: 'Häufiger Konsignationsartikel'
                    };
                    consignmentInventory.push(newProduct);
                    renderConsignmentTable();
                } else {
                    const newProduct = {
                        ...template,
                        name: productName,
                        currentStock: 0,
                        minLevel: 5,
                        maxLevel: 20,
                        supplier: 'Selgros',
                        notes: 'Häufiger Artikel'
                    };
                    inventory.push(newProduct);
                    renderInventoryTable();
                }
                updateStats();
            }
        }

        // Initialize system on load
        document.addEventListener('DOMContentLoaded', function() {
            initializeInventory();
            
            // Add Export button to main inventory tab
            const inventoryTab = document.getElementById('inventory');
            const exportBtn = document.createElement('button');
            exportBtn.className = 'btn';
            exportBtn.textContent = 'Als CSV exportieren';
            exportBtn.onclick = exportToCSV;
            exportBtn.style.backgroundColor = '#f39c12';
            
            const buttonContainerInventory = inventoryTab.querySelector('h2').nextElementSibling;
            buttonContainerInventory.appendChild(exportBtn);
            
            // Quick-Add Buttons for common articles
            const quickAddDiv = document.createElement('div');
            quickAddDiv.innerHTML = '<h4>Häufige Artikel schnell hinzufügen:</h4>';
            
            Object.keys(commonProducts).forEach(productName => {
                const btn = document.createElement('button');
                btn.className = 'btn';
                btn.textContent = `+ ${productName}`;
                btn.onclick = () => quickAddProduct(productName);
                btn.style.backgroundColor = commonProducts[productName].isConsignment ? '#9b59b6' : '#27ae60'; // Different color for consignment quick-add
                btn.style.margin = '2px';
                btn.style.fontSize = '12px';
                btn.style.padding = '5px 10px';
                quickAddDiv.appendChild(btn);
            });
            
            inventoryTab.insertBefore(quickAddDiv, inventoryTab.querySelector('.search-box'));
            
            // Automatic stock check every 30 seconds
            setInterval(checkCriticalStock, 30000);
            
            console.log('Sophien Post und Shop Lagerverwaltung geladen');
            console.log('Standort: Frankfurt am Main, Deutschland');
        });
    </script>
</body>
</html>